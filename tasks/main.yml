---
  - name: Ensure OpenSSL is installed
    apt: name=openssl state=present
    when: ansible_os_family == "Debian"

  - name: Ensure sc_deploy_path exists
    file: path={{ sc_deploy_path }} state=directory owner={{ sc_deploy_owner }} group={{ sc_deploy_group }} mode={{ sc_mode }}

  - name: Ensure sc_certs_path exists
    file: path={{ sc_certs_path }} state=directory owner={{ sc_deploy_owner }} group={{ sc_deploy_group }} mode={{ sc_mode }}

  - local_action: stat path={{ sc_local_private_key_path }}
    register: stat_key
    become: no

  - local_action: stat path={{ sc_local_cert_path }}
    register: stat_cert
    become: no

  - name: Test if private_key file is needed
    fail: msg = "sc_local_private_key_path {{ sc_local_private_key_path }} is missing"
    when: not stat_key.stat.exists and stat_cert.stat.exists

  - name: Test if cert file is needed
    fail: msg = "sc_local_cert_path {{ sc_local_cert_path }} is missing"
    when: stat_key.stat.exists and not stat_cert.stat.exists

  - include: generate-csr.yml
    when: >
      ( generate_csr|bool == true ) and
      ( not stat_key.stat.exists and not stat_cert.stat.exists )

  - include: generate-ssc.yml
    when: >
      ( generate_ssc|bool == true ) and
      ( not stat_key.stat.exists and not stat_cert.stat.exists )

  - include: copy-ssc.yml
    when: >
      ( generate_csr|bool == true )

  - name: Generate strong DHE parameter - https://weakdh.org/
    command: openssl dhparam -out {{ sc_dhparam_fn }} {{ dhparam_size }} creates={{ sc_dhparam_fn }}
    when: ( generate_dh_param|bool == true )
